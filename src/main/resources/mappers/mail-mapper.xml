<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="mailMapper">
	
	<resultMap id="mailResult" type="Mail">
		<id column="mail_no" property="mailNo"/>
		<result column="sender" property="sender"/>
		<result column="sender_mail" property="senderMail"/>
		<result column="recipient_mail" property="recipientMail"/>
		<result column="ref_mail" property="refMail"/>
		<result column="hid_ref_mail" property="hidRefMail"/>
		<result column="mail_title" property="mailTitle"/>
		<result column="mail_content" property="mailContent"/>
		<result column="sent_date" property="sentDate"/>
		<result column="temp_status" property="tempStatus"/>

		<result column="important_status" property="importantStatus"/>		
		<result column="read_status" property="readStatus"/>
		<result column="mail_type" property="mailType"/>
		<result column="attachment_status" property="attachmentStatus"/>
	</resultMap>
	
	<resultMap id="mailAttachmentResult" type="MailAttachment">
		<id column="file_no" property="fileNo"/>
		<result column="mail_no" property="mailNo"/>
		<result column="origin_name" property="originName"/>
		<result column="change_name" property="changeName"/>
	</resultMap>
	
	<insert id="sendMail">
		insert
		  into mail
		  (
		    mail_no
		  , sender
		  , sender_mail
		  , recipient_mail
		  , ref_mail
		  , hid_ref_mail
		  , mail_title
		  , mail_content
		  )
		  values
		  (
		    seq_mailno.nextval
		  , #{sender}
		  , #{senderMail}
		  , #{recipientMail}
		  , #{refMail}
		  , #{hidRefMail}
		  , #{mailTitle}
		  , #{mailContent}
		  )
	</insert>
	
	<insert id="sendAttachment">
		insert
		  into mail_attachment
		  (
		    file_no
		  , mail_no
		  , origin_name
		  , change_name
		  )
		  values
		  (
		    seq_mailatno.nextval
		  , seq_mailno.currval
		  , #{originName}
		  , #{changeName}
		  )
	</insert>
	
	<insert id="insertStatus">
		insert
		  into mail_status
		  (
		    mail_no
		  , sender_mail
		  , recipient_mail
		  , mail_type
		  , important_status
		  )
		  values
		  (
		    seq_mailno.currval
		  , #{senderMail}
		  , #{recipientMail}
		  , #{mailType}
		  , #{importantStatus}
		  )
	</insert>
	
	<select id="selectRecieveListCount" resultType="_int">
		select count(*)
		  from mail_status
		 where recipient_mail = #{userMail}
		   and bin_status = 'N'
	</select>
	
	<select id="selectRecieveList" resultMap="mailResult">
		select
		       mail_no
		     , sender_mail
		     , mail_title
		     , to_char(sent_date, 'yyyy.mm.dd hh24:mi') sent_date
		     , (
		        select important_status
		          from mail_status s
		         where m.mail_no = s.mail_no
		           and recipient_mail = #{userMail}
		       ) important_status
		     , (
		        select count(read_date)
		          from mail_status s
		         where m.mail_no = s.mail_no
		           and recipient_mail = #{userMail}
		       ) read_status
		     , (
		        select mail_type
		          from mail_status s
		         where m.mail_no = s.mail_no
		           and recipient_mail = #{userMail}
		       ) mail_type
		     , (
		        select count(*)
		          from mail_attachment at
		         where m.mail_no = at.mail_no
		       ) attachment_status
		  from mail m
		 where recipient_mail like '%' || #{userMail} || '%'
		    or ref_mail like '%' || #{userMail} || '%'
		    or hid_ref_mail like '%' || #{userMail} || '%'
		 order
		    by mail_no desc
	</select>
	
</mapper>
